<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baby Sensor Live - KMC</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 1em;
      background: #f9fafb;
    }
    h1 { font-size: 1.3rem; margin-bottom: 0.5em; }
    button {
      margin: 4px;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 0.95rem;
    }
    #status {
      margin: 0.5em 0;
      font-weight: 600;
      color: #374151;
    }
    #logs {
      white-space: pre-wrap;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 8px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
    }

    /* ðŸ”‹ Battery badge */
    #battery-badge{
      position: fixed;
      top: 8px; right: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      font: 600 14px system-ui, sans-serif;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }
    #battery-badge.low   { background:#fff1f2; border-color:#fecaca; }
    #battery-badge.warn  { background:#fffbeb; border-color:#fde68a; }
    #battery-badge.ok    { background:#ecfdf5; border-color:#a7f3d0; }

    canvas { max-width: 100%; margin-top: 10px; border-radius: 6px; }
  </style>
</head>

<body>
  <h1>Baby Sensor Live â€“ KMC</h1>

  <!-- ðŸ”‹ Battery display -->
  <div id="battery-badge" class="battery ok" aria-label="Battery level">
    ðŸ”‹ <span id="battery-pct">--</span>%
  </div>

  <div>
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
    <button id="start">Start + Record</button>
    <button id="stop">Stop + Save CSV</button>
    <button id="clear">Clear Logs</button>
  </div>

  <div id="status">Status: Idle</div>
  <div id="logs"></div>

  <canvas id="timeseries" height="140"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ========== Chart Setup ==========
    const tsCtx = document.getElementById('timeseries').getContext('2d');
    const tsData = { labels: [], datasets: [{ label: 'Sensor', data: [] }] };
    const tsChart = new Chart(tsCtx, {
      type: 'line',
      data: tsData,
      options: { animation: false, scales: { x: { display: false } } }
    });

    function pushPoint(v, max = 1000) {
      tsData.labels.push(Date.now());
      tsData.datasets[0].data.push(v);
      if (tsData.labels.length > max) {
        tsData.labels.shift();
        tsData.datasets[0].data.shift();
      }
      tsChart.update('none');
    }

    // ========== Battery Badge ==========
    const $batteryBadge = document.getElementById('battery-badge');
    const $batteryPct   = document.getElementById('battery-pct');

    function updateBattery(pct){
      if (Number.isFinite(pct) && pct >= 0 && pct <= 100) {
        $batteryPct.textContent = pct;
        $batteryBadge.classList.remove('low','warn','ok');
        if (pct <= 20)      $batteryBadge.classList.add('low');
        else if (pct <= 40) $batteryBadge.classList.add('warn');
        else                $batteryBadge.classList.add('ok');
      }
    }

    function peelBatteryFromLine(line){
      const m = line.trim().match(/(\d{2})\s*$/);
      if (!m) return { dataLine: line, battery: null };
      const battery = parseInt(m[1], 10);
      const dataLine = line.slice(0, line.lastIndexOf(m[1])).trim();
      return { dataLine, battery: (battery >= 0 && battery <= 100) ? battery : null };
    }

    // ========== BLE Handling ==========
    let device, characteristic;
    const decoder = new TextDecoder();
    let buffer = '';

    async function connectDevice() {
      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service'] // replace with your custom UUID if needed
        });
        const server = await device.gatt.connect();
        const services = await server.getPrimaryServices();
        // use your actual notify characteristic here:
        const service = services[0];
        const chars = await service.getCharacteristics();
        characteristic = chars.find(c => c.properties.notify);
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', onBleNotify);
        setStatus('Connected');
      } catch (err) {
        console.error(err);
        setStatus('Connect failed');
      }
    }

    async function disconnectDevice() {
      try {
        if (device && device.gatt.connected) device.gatt.disconnect();
        setStatus('Disconnected');
      } catch(e){ console.error(e); }
    }

    function setStatus(t){ document.getElementById('status').textContent = 'Status: ' + t; }

    async function onBleNotify(e){
      const dv = e.target.value;
      const u8 = new Uint8Array(dv.buffer, dv.byteOffset, dv.byteLength);
      buffer += decoder.decode(u8, { stream: true });

      let lines = buffer.split(/\r?\n/);
      buffer = lines.pop();

      for (const raw of lines) {
        if (!raw.trim()) continue;
        const { dataLine, battery } = peelBatteryFromLine(raw);
        if (battery !== null) updateBattery(battery);

        const val = parseFloat(dataLine);
        if (!isNaN(val)) pushPoint(val);
        appendLog(raw);
      }
    }

    function appendLog(text) {
      const logs = document.getElementById('logs');
      logs.textContent += text + "\n";
      logs.scrollTop = logs.scrollHeight;
    }

    // Buttons
    document.getElementById('connect').onclick = connectDevice;
    document.getElementById('disconnect').onclick = disconnectDevice;
    document.getElementById('clear').onclick = () => document.getElementById('logs').textContent = '';
  </script>
</body>
</html>
