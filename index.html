<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Baby Sensor Live (DBG)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" href="icons/icon-192.png" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
           margin:0; padding:0; background:#0b1220; color:#e5e7eb }
    header { padding:14px 16px; background:#0f172a; position:sticky; top:0; z-index:10; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    header h1 { font-size:18px; margin:0; font-weight:600 }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:12px; margin:12px }
    label { display:block; font-size:12px; color:#9ca3af; margin-bottom:4px }
    input[type="text"] { width:100%; padding:10px; border-radius:10px; border:1px solid #374151; background:#0b1020; color:#e5e7eb }
    button { padding:10px 14px; border-radius:10px; border:1px solid #374151; background:#1f2937; color:#e5e7eb }
    button.primary { background:#2563eb; border-color:#1d4ed8 }
    button:disabled { opacity:.5 }
    .row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
    .pill { font-size:12px; padding:6px 10px; background:#0b1020; border:1px solid #243046; border-radius:9999px; display:inline-block }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
    pre { white-space:pre-wrap; max-height:240px; overflow:auto; margin:0 }
  </style>
</head>
<body>
  <header>
    <h1>Baby Sensor Live</h1>
    <span class="pill" id="status">idle</span>
    <button id="installBtn" hidden>Install</button>
  </header>

  <div class="card">
    <div class="row-3">
      <div>
        <label>BLE Service UUID</label>
        <input id="serviceUUID" type="text" placeholder="6e400001-b5a3-f393-e0a9-e50e24dcca9e" />
      </div>
      <div>
        <label>Notify Characteristic UUID (device → phone)</label>
        <input id="notifyUUID" type="text" placeholder="6e400006-b5a3-f393-e0a9-e50e24dcca9e" />
      </div>
      <div>
        <label>Write Characteristic UUID (phone → device) — optional</label>
        <input id="writeUUID" type="text" placeholder="6e400002-b5a3-f393-e0a9-e50e24dcca9e" />
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap: wrap">
      <button class="primary" id="connectBtn">Connect (acceptAllDevices)</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
      <button id="clearBtn">Clear Log</button>
      <button id="scanBtn">List Services</button>
    </div>
    <small class="mono">Use your values: service=...001, notify=...006, write=...002</small>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">Debug Log</h3>
    <pre id="log" class="mono"></pre>
  </div>

<script>
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.hidden = false; });
installBtn.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installBtn.hidden = true; });

if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js')); }

const $ = (id) => document.getElementById(id);
const statusEl = $('status'), logEl = $('log');
const serviceUUIDEl = $('serviceUUID'), notifyUUIDEl = $('notifyUUID'), writeUUIDEl = $('writeUUID');
const connectBtn = $('connectBtn'), disconnectBtn = $('disconnectBtn'), scanBtn = $('scanBtn'), clearBtn = $('clearBtn');

serviceUUIDEl.value = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
notifyUUIDEl.value  = '6e400006-b5a3-f393-e0a9-e50e24dcca9e';
writeUUIDEl.value   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

function setStatus(t){ statusEl.textContent = t; }
function log(...args){ const s = args.map(a => (a instanceof Error ? (a.stack||a.message) : (typeof a==='object'? JSON.stringify(a): String(a)))).join(' '); logEl.textContent += s + "\n"; logEl.scrollTop = logEl.scrollHeight; console.log(...args); }

let device, server;

async function connect(){
  try{
    setStatus('requesting device…');
    const serviceUUID = serviceUUIDEl.value.trim();
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [serviceUUID]
    });
    log('Selected device:', device.name || '(no name)');
    device.addEventListener('gattserverdisconnected', () => { setStatus('disconnected'); log('GATT disconnected'); connectBtn.disabled = false; disconnectBtn.disabled = true; });

    setStatus('connecting…');
    server = await device.gatt.connect();
    log('GATT connected');
    const svc = await server.getPrimaryService(serviceUUID);
    log('Got service', serviceUUID);

    const notifyUUID = notifyUUIDEl.value.trim();
    const writeUUID  = writeUUIDEl.value.trim();

    const notifyChar = await svc.getCharacteristic(notifyUUID);
    log('Got notify characteristic', notifyUUID, 'props=', notifyChar.properties);
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', (e) => {
      const txt = new TextDecoder().decode(e.target.value);
      log('NOTIFY:', txt.replace(/\r/g,''));
    });

    if(writeUUID){
      const writeChar = await svc.getCharacteristic(writeUUID);
      log('Got write characteristic', writeUUID, 'props=', writeChar.properties);
    }

    connectBtn.disabled = true; disconnectBtn.disabled = false;
    setStatus('connected');
  }catch(err){
    setStatus('error');
    log('ERROR:', err);
  }
}

async function listServices(){
  try{
    if(!device){ log('No device yet. Click Connect first.'); return; }
    if(!server || !server.connected){ log('Not connected.'); return; }
    const services = await server.getPrimaryServices();
    log('Primary services count:', services.length);
    for(const s of services){
      log('Service:', s.uuid);
      try {
        const chars = await s.getCharacteristics();
        for(const c of chars){
          log('  Char:', c.uuid, 'props=', JSON.stringify(c.properties));
        }
      } catch(e){ log('  getCharacteristics error:', e.message); }
    }
  }catch(e){ log('ERROR listServices:', e); }
}

async function disconnect(){
  try{ if(device && device.gatt.connected){ device.gatt.disconnect(); } }catch{}
}

connectBtn.addEventListener('click', connect);
disconnectBtn.addEventListener('click', disconnect);
scanBtn.addEventListener('click', listServices);
clearBtn.addEventListener('click', () => logEl.textContent = '');

if (!('bluetooth' in navigator)) { setStatus('Web Bluetooth not supported'); log('This device/browser does not support Web Bluetooth.'); } else { setStatus('ready'); }
</script>
</body>
</html>
